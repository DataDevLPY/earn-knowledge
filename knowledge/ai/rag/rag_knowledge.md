[TOC]



## RAG 主要流程

* RAG (Retrieval Augmented Generation， 检索增强生成) 
* 大模型有两个缺点：
  * 知识有滞后性：不知道最近发生的新闻
  * 不懂内部机密：没看过公司内部文档
* **Retrieval（检索）**：用户提问时，先不去问大模型，而是先从向量库，把和问题相关的资料片段找出来。

* **Augmented（增强）**：把用户的问题和检索出来的资料缝合在一起，形成一个信息量更大的提示词（Prompt）。
* **Generation（生成）**：把这个缝合好的提示词喂给大模型，生成准确的答案。



## RAG中的Rerank

* Retrieval（初步检索）/ Rerank（重排序）
* Rerank的核心价值就是在**速度**和**精度**间做了一个平衡。先用向量保速度，再用Rerank保精度。
* Rerank能够利用更高级的模型捕捉查询与文档之间的语义联系，从而剔除无关文档
* 常见的Rerank模型
  * BAAI / bge-reranker-base （开源）[https://huggingface.co/BAAI/bge-reranker-base]



## 混合检索 / 多路召回 / 融合检索

混合检索是指在RAG的过程中，结合向量检索和关键词检索进行互补，从而提高检索结果的全面性和准确性。

* 混合检索通过并行两种检索实现：
  * **向量检索：**将文本转化为高维向量，计算语义相似度。
  * **关键词检索：**基于倒排索引、BM25等算法，精确匹配关键词。
  * 两种结果通过权重融合或Rerank模型合并，输出最优答案。



## 数据预处理 优化检索精度

```text
原始数据（多格式）  
│  
├─ 格式转换（提取纯文本）  
│  ├─ PDF → PyPDF2提取文本  
│  ├─ HTML → BeautifulSoup解析正文  
│  └─ Excel → Pandas读取表格内容  
│  
├─ 清洗降噪  
│  ├─ 去除重复（相邻重复段落检测）  
│  ├─ 过滤噪声（正则表达式去除标点、特殊符号）  
│  └─ 敏感信息处理（PII检测库删除隐私数据）  
│  
├─ 智能分块（核心步骤）  
│  ├─ 动态切分：按“标题→段落→句子”优先级切分（如先按“### 第三章”分章节，再按句号分句）  
│  ├─ 长度校验：单块不超过模型最大token数的60%（预留空间给用户问题和提示词）  
│  └─ 重叠处理：相邻块保留10%重叠（如块1结尾100字作为块2开头，避免切断跨段语义）  
│  
├─ 语义增强  
│  ├─ 元数据标注：  
│  │  ├─ 规则提取：用正则匹配“2024年”“张三”等实体  
│  │  └─ LLM提取：用GPT-4生成“核心关键词”“所属部门”等标签  
│  └─ 向量化：  
│     ├─ 通用模型：Sentence-BERT（快速上线）  
│     └─ 领域模型：BGE-M3（多语言）、ColBERTv2（长文本优化）  
│  
└─ 存储索引  
   ├─ 向量库：Milvus（高并发）  
   └─ 关键词库：Elasticsearch（BM25算法）+ 元数据索引（支持过滤查询）  

```



## 查询扩展 & 意图识别

* RAG的核心是先检索后生成，如果原始查询覆盖范围不足或者不够精确，会导致检索的文档或者信息不全。所以需要做词汇匹配、语义补全。